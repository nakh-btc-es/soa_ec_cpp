function varargout = ep_ec_args_eval(varargin)
% Checking provided options for validity.
%
%    Allowed Keys:            Meaning of the Value:
%    - ModelFile                (string)*   The absolute path to the Simulink model.
%    - InitScriptFile           (string)*   The absolute path to the init script of the Simulink model. (can be empty)
%
%    - FixedStepSolver          (string)*   ('yes' | 'no')
%                                           Handling when a non-fixed-step solver is ecountered: If 'yes', the solver
%                                           is automatically set to fixed-step. Otherwise an error is issued.
%    - ParameterHandling        (string)*   The parameter handling, either 'Off' or 'ExplicitParam'.
%    - TestMode                 (string)*   The test mode, either 'BlackBox' or 'GreyBox'.
%                                           ----------------------------------------------------------------------------
%    - DSReadWriteObservable    (boolean)   If set to true, Data Stores used as both DSRead and DSWrite are used as an 
%                                           output instead of rejecting them.            
%                                           ----------------------------------------------------------------------------
%    - AddCodeModel             (string)*   ('yes' | 'no')
%                                           ----------------- 'yes' ----------------------------------------------------
%                                           Simulink model and C-Code model are imported.
%                                           ----------------- 'no' -----------------------------------------------------
%                                           CodeModel file and Mapping file are not extracted for the import. Meaning
%                                           only the Simulink model is analyzed. C-Code and mapping are omitted.
%                                           ----------------------------------------------------------------------------
%    - GlobalConfigFolderPath   (string)*   Path to the global configuration folder
%    - CompilerFile             (string)*   Location where the Compiler file shall be placed.
%    - AddModelInfoFile         (string)*   Location where the AddModelInfoFile shall be placed.
%    - SlArchFile               (string)*   Location where the SL architecture file shall be placed.
%    - SlConstrFile             (string)*   Location where the SL constraint file shall be placed.
%    - MappingFile              (string)*   Location where the Mapping file shall be placed.
%    - CodeModelFile            (string)*   Location where the CodeModel file shall be placed.
%    - MessageFile              (string)*   Location where the Message file shall be placed.
%    - ConstantsFile            (string)*   Location where the Constants file shall be placed.
%
%    - Progress                 (object)    Object for tracking progress, e.g. UI workflow.
%

%%
casValidKeys = { ...
    'ModelFile', ...
    'InitScriptFile', ...
    'ParameterHandling', ...
    'TestMode', ...
    'DSReadWriteObservable', ...
    'FixedStepSolver', ...
    'AddCodeModel', ...
    'GlobalConfigFolderPath', ...
    'TempDir', ...
    'Progress', ...
    'CompilerFile', ...
    'AddModelInfoFile', ...
    'MappingFile', ...
    'ConstantsFile', ...
    'CodeModelFile', ...
    'SlArchFile', ...
    'SlConstrFile', ...
    'MessageFile', ...
    'ReuseExistingCode'};

if (nargin < 1)
    varargout{1} = casValidKeys;
else
    varargout{1} = i_evalArgs(casValidKeys, varargin{:});   
end
end


%%
function stArgs = i_evalArgs(casValidKeys, varargin)
stArgs = ep_core_transform_args(varargin, casValidKeys);

ep_core_check_args({'ModelFile'}, stArgs, 'obligatory', 'file');
ep_core_check_args({'InitScriptFile'}, stArgs, 'file');
ep_core_check_args({'ParameterHandling'}, stArgs, {'class', 'char'}, {'keyvalue_i', {'ExplicitParam', 'Off'}});
ep_core_check_args({'TestMode'}, stArgs, {'class', 'char'}, {'keyvalue_i', {'GreyBox', 'BlackBox'}});
ep_core_check_args({'DSReadWriteObservable'}, stArgs, {'class', 'logical'});
ep_core_check_args({'FixedStepSolver'}, stArgs, {'class', 'char'}, {'keyvalue_i', {'yes', 'no'}});
ep_core_check_args({'ReuseExistingCode'}, stArgs, {'class', 'char'}, {'keyvalue_i', {'yes', 'no'}});

% normalize all file arguments
casFiles = { ...
    'ModelFile', ...
    'InitScriptFile', ...
    'CompilerFile', ...
    'AddModelInfoFile', ...
    'MappingFile', ...
    'CodeModelFile', ...
    'SlArchFile', ...
    'SlConstrFile', ...
    'MessageFile', ...
    'GlobalConfigFolderPath', ...
    'TempDir'};
for i = 1:numel(casFiles)
    sOutFile = casFiles{i};
    
    if (isfield(stArgs, sOutFile) && ~isempty(stArgs.(sOutFile)))
        stArgs.(sOutFile) = ep_core_canonical_path(stArgs.(sOutFile), pwd);
    end
end

% fill optional arguments with defaults
stDefaults = struct ( ...
    'InitScriptFile',         '', ...
    'ParameterHandling',      'ExplicitParam', ...
    'DSReadWriteObservable',  false, ...
    'TestMode',               'GreyBox', ...
    'FixedStepSolver',        'no', ...
    'AddCodeModel',           'yes', ...
    'GlobalConfigFolderPath', '', ...
    'ReuseExistingCode',      'no',  ...
    'Progress',               []);
casOptionalArgs = fieldnames(stDefaults);
for i = 1:numel(casOptionalArgs)
    sOptArg = casOptionalArgs{i};
    
    if ~isfield(stArgs, sOptArg)
        stArgs.(sOptArg) = stDefaults.(sOptArg);
    end
end

% fill out derived arguments
[~, stArgs.Model] = fileparts(stArgs.ModelFile);
stArgs.ResultDir = fileparts(stArgs.AddModelInfoFile); % TODO: ... find a better way (more explicit)!
end



